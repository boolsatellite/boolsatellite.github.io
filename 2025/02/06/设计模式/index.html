<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="设计模式组件协作模式 现代软件分工之后的第一个结果是”框架与应用程序的划分”，”组件协作”模式通过晚期绑定来实现框架与应用程序的松耦合，是二者之间协作时常用的模式 典型模式：  Template Method Strategy Observer &#x2F; Event   模板方法： Motivation  在软件的构建过程中，对于某一项任务，它常常有稳定的整体结构，但各个子步骤却有很多改变的需">
<meta property="og:type" content="article">
<meta property="og:title" content="设计模式">
<meta property="og:url" content="http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/index.html">
<meta property="og:site_name" content="boolsatellite">
<meta property="og:description" content="设计模式组件协作模式 现代软件分工之后的第一个结果是”框架与应用程序的划分”，”组件协作”模式通过晚期绑定来实现框架与应用程序的松耦合，是二者之间协作时常用的模式 典型模式：  Template Method Strategy Observer &#x2F; Event   模板方法： Motivation  在软件的构建过程中，对于某一项任务，它常常有稳定的整体结构，但各个子步骤却有很多改变的需">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/Snipaste_2024-12-13_22-48-45.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2024-12-15_12-35-16.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2024-12-16_16-35-00.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2024-12-20_20-10-18.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2024-12-24_13-14-42.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2024-12-24_13-31-45.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2024-12-27_15-42-55.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2024-12-28_13-20-38.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2024-12-29_18-13-38.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2024-12-30_13-03-16.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2025-01-05_13-17-19.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2025-01-08_10-59-52.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2025-01-09_10-24-03.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2025-01-10_11-15-05.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2025-01-11_12-59-19.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2025-01-12_12-22-33.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2025-01-15_12-03-40.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2025-01-16_12-10-29.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2025-01-17_14-18-44.png">
<meta property="og:image" content="http://example.com/img/Snipaste_2025-01-23_11-04-19.png">
<meta property="article:published_time" content="2025-02-05T16:00:00.000Z">
<meta property="article:modified_time" content="2025-02-14T03:42:13.984Z">
<meta property="article:author" content="boolsatellite">
<meta property="article:tag" content="设计模式">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/Snipaste_2024-12-13_22-48-45.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>设计模式</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="boolsatellite" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/boolsatellite">Projects</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/12/12/%E7%A7%8B%E6%8B%9B%E6%97%A5%E8%AE%B0/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&text=设计模式"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&title=设计模式"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&is_video=false&description=设计模式"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=设计模式&body=Check out this article: http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&title=设计模式"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&title=设计模式"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&title=设计模式"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&title=设计模式"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&name=设计模式&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&t=设计模式"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">设计模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%8D%8F%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">组件协作模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">模板方法：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.2.</span> <span class="toc-text">策略模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.3.</span> <span class="toc-text">观察者模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">单一职责模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.1.</span> <span class="toc-text">装饰模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%A5%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">桥模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">对象创建模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.1.</span> <span class="toc-text">工厂方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82"><span class="toc-number">1.3.2.</span> <span class="toc-text">抽象工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">原型模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E6%80%A7%E8%83%BD%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">对象性能模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%BB%B6%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.1.</span> <span class="toc-text">单件模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.2.</span> <span class="toc-text">享元模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.</span> <span class="toc-text">接口隔离模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%A8%E9%9D%A2%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.1.</span> <span class="toc-text">门面模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.2.</span> <span class="toc-text">代理模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.3.</span> <span class="toc-text">适配器模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E4%BB%8B%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.4.</span> <span class="toc-text">中介者模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.6.</span> <span class="toc-text">状态变化模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.6.1.</span> <span class="toc-text">状态模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.6.2.</span> <span class="toc-text">备忘录模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.</span> <span class="toc-text">数据结构模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.1.</span> <span class="toc-text">组件模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%8C%E8%B4%A3%E9%93%BE"><span class="toc-number">1.7.2.</span> <span class="toc-text">职责链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%8C%E4%B8%BA%E5%8F%98%E5%8C%96%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.8.</span> <span class="toc-text">行为变化模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.8.1.</span> <span class="toc-text">命令模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%99%A8"><span class="toc-number">1.8.2.</span> <span class="toc-text">访问器</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        设计模式
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">boolsatellite</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-02-05T16:00:00.000Z" itemprop="datePublished">2025-02-06</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h1><h2 id="组件协作模式"><a href="#组件协作模式" class="headerlink" title="组件协作模式"></a>组件协作模式</h2><blockquote>
<p>现代软件分工之后的第一个结果是”框架与应用程序的划分”，”组件协作”模式通过晚期绑定来实现框架与应用程序的松耦合，是二者之间协作时常用的模式</p>
<p>典型模式：</p>
<ul>
<li>Template Method</li>
<li>Strategy</li>
<li>Observer &#x2F; Event</li>
</ul>
</blockquote>
<h3 id="模板方法："><a href="#模板方法：" class="headerlink" title="模板方法："></a>模板方法：</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件的构建过程中，对于某一项任务，它常常有稳定的整体结构，但各个子步骤却有很多改变的需求，或者由于固有的原因(如框架与应用之间的关系)而无法和任务的整体结构同时实现</p>
<p>如何在确定稳定操作结构的前提下，来灵活应对各个子步骤的变化或者晚期实现需求?</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 库开发者</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Library</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">step1</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">step3</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">step5</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用开发人员</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">step2</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">step4</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Library lib;</span><br><span class="line">  Application app;</span><br><span class="line">  lib.<span class="built_in">step1</span>();</span><br><span class="line">  <span class="keyword">if</span>(app.<span class="built_in">step2</span>()) &#123; lib.<span class="built_in">step3</span>(); &#125;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span> ; i&lt;<span class="number">4</span> ; ++i) &#123;</span><br><span class="line">    app.<span class="built_in">step4</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显然如上设计是结构化的1 3 5 由库开发人员编写，2 4 由业务开发编写，并且业务开发人员实现了程序的主流程</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 库开发者</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Library</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">step1</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">step2</span>()) &#123;<span class="built_in">step3</span>();&#125; </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span> ; i&lt;<span class="number">4</span> ; ++i) &#123;</span><br><span class="line">      <span class="built_in">step4</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">step5</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Library</span>() &#123;&#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">step1</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// 稳定</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">step3</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// 稳定</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">step5</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// 稳定</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">step2</span><span class="params">()</span> </span>= <span class="number">0</span>; <span class="comment">// 变化</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">step4</span><span class="params">()</span> </span>= <span class="number">0</span>; <span class="comment">// 变化</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用开发人员</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Application</span> : Library &#123;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">step2</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">step4</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Library* pLib = <span class="keyword">new</span> Application;</span><br><span class="line">  pLib-&gt;<span class="built_in">Run</span>();</span><br><span class="line">  <span class="keyword">delete</span> pLib;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如今库开发人员负责 1 3 5 以及程序的主流程，应用开发人员负责 2 4，这就实现了调用关系的反转，原来是应用开发人员在程序主流程中调用库函数这是早绑定，如今成为了库函数调用应用开发的函数(通过虚函数)这是晚绑定，极大的减少了应用程序开发人员的负担</p>
<blockquote>
<p>define</p>
</blockquote>
<p>定义一个操作中算法 的骨架(稳定)，而将一些步骤(变化)延迟到子类中。 Template Method 使得子类可以不改变(复用)一个算法的结构即可重定义该算法(Run方法，稳定的)中某些特定的步骤。</p>
<p><img src="/img/Snipaste_2024-12-13_22-48-45.png"></p>
<ul>
<li>Template Method 模式用最简洁的机制(虚函数多态)为很多应用程序框架提供了灵活的拓展点，是代码复用方面的基本实现结构</li>
<li>除了可以灵活应对子步骤的变化之外，”不要调用我，让我来调用你”的反向控制结构，是 Template Method 的典型应用</li>
<li>在具体实现方面，被 Template Method 调用的方法一般设计为 protected 方法，应为这些方法单独使用没有意义，只有在流程中使用才有意义</li>
</ul>
<h3 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件构建过程中，某些对象使用的算法可能多种多样，经常改变，如果将这些算法都编码到对象中，将会使对象变得异常复杂，而且有时候支持不使用的算法也是一个性能负担，如何在运行时根据需要透明的更改对象的算法？将算法与对象本身解耦，从而避免上述问题？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">TaxBase</span> &#123;</span><br><span class="line">  CN_Tax,</span><br><span class="line">  US_Tax,</span><br><span class="line">  DE_Tax,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SalesOrder</span> &#123;</span><br><span class="line">  TaxBase tax;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">double</span> <span class="title">CalculateTax</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(tax == CN_Tax) &#123;<span class="comment">/**/</span>&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(tax == US_Tax) &#123;<span class="comment">/**/</span>&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(tax == DE_Tax) &#123;<span class="comment">/**/</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如上代码，我们通过枚举各国的税率，在<code>CalculateTax</code>中使用开关语句来进行计算。当我们业务需求变化的时候，如新增计算法国的税率需求，首先我们要添加枚举，之后再增加<code>CalculateTax</code>中的开关语句，这违反了开闭原则。 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TaxStrategy</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">double</span> <span class="title">Calculate</span><span class="params">(<span class="type">const</span> Contex&amp; contex)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">TaxStrategy</span>()&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CNTax</span> : <span class="keyword">public</span> TaxStrategy &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">double</span> <span class="title">Calculate</span><span class="params">(<span class="type">const</span> Contex&amp; contex)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">USTax</span> : <span class="keyword">public</span> TaxStrategy &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">double</span> <span class="title">Calculate</span><span class="params">(<span class="type">const</span> Contex&amp; contex)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SalesOrder</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  TaxStrategy&amp; strategy;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">SalesOrder</span>(TaxStrategy&amp; tax_strategy) : <span class="built_in">strategy</span>(tax_strategy)&#123;&#125;</span><br><span class="line">  <span class="function"><span class="type">double</span> <span class="title">CalculateTax</span><span class="params">(<span class="type">const</span> Contex&amp; contex)</span> </span>&#123;</span><br><span class="line">    strategy.<span class="built_in">Calculate</span>(contex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当我们要支持法国的税法时，我们要实现派生类继承<code>TaxStrategy</code>，不需要改变<code>SalesOrder</code>，在调用时只需传入不同的参数</p>
<blockquote>
<p>define</p>
</blockquote>
<p>定义一系列算法，把它们一个个封装起来，并且使他们可以互相替换。该模式使算法(变化)可独立于使用它的客户程序(稳定)而变化(拓展)</p>
<p><img src="/img/Snipaste_2024-12-15_12-35-16.png"></p>
<ul>
<li>Strategy 及其子类为组件提供了一系列可重用的算法，从而可以使得类型在运行时方便地根据需要在各个算法之间切换</li>
<li>Strategy模式提供了用条件判断语句以外的另一种选择，消除条件判断语句，就是在解耦合。含有许多条件判断语句的代码通常都需要Strategy模式</li>
<li>如果Strategy对象没有实例变量，那么各个上下文可以共享同一个Strategy对象，从而节省对象开销(配合单例模式)</li>
</ul>
<h3 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件构造的过程中，我们需要为某些对象建立一种”通知依赖关系”，一个对象(目标对象)的状态发生改变，所有依赖对象(观察者对象)都将得到通知。如果这样的依赖关系过于紧密，将使软件不能很好地抵御变化。使用面向面向对象技术，可以将这种依赖关系弱化，并形成一种稳定的依赖关系。从而实现软件体系结构的松耦合。 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FileSplitter</span> &#123;</span><br><span class="line">  string m_filePath;</span><br><span class="line">  <span class="type">int</span> m_fileNumber;</span><br><span class="line">  ProcessBar* m_processBar;     <span class="comment">// 新增进度条参数</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">FileSplitter</span>(<span class="type">const</span> string&amp; filePath , <span class="type">int</span> fileNumber , ProcessBar* processBar)  <span class="comment">// 新增进度条参数</span></span><br><span class="line">    : <span class="built_in">m_filePath</span>(filePath) , <span class="built_in">m_fileNumber</span>(fileNumber) , <span class="built_in">m_processBar</span>(processBar) &#123; &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 读取大文件</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span> ; i&lt;m_fileNumber ; ++i) &#123;</span><br><span class="line">      m_processBar-&gt;<span class="built_in">setvalue</span>((i+<span class="number">1</span>)/m_fileNumber);   <span class="comment">// 新增 进度条逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainForm</span> : <span class="keyword">public</span> Form &#123;</span><br><span class="line">  TextBox* txtFilePath;     <span class="comment">// 所要分割的文件路径</span></span><br><span class="line">  TextBox* txtFileNumber;   <span class="comment">// 所要分割的文件数目</span></span><br><span class="line">  ProcessBar* processBar;   <span class="comment">// 新增进度条</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Button1_Click</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    string filePath = txtFilePath-&gt;<span class="built_in">getText</span>();</span><br><span class="line">    <span class="type">int</span> number = <span class="built_in">atoi</span>(txtFileNumber-&gt;<span class="built_in">getText</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="function">FileSplitter <span class="title">splitter</span><span class="params">(filePath , number)</span></span>;</span><br><span class="line">    splitter.<span class="built_in">split</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在原本的功能上我们需要添加进度条的功能，如上代码是我们最先能想到的，但是这违反了依赖倒置原则， <code>FileSplitter</code> 属于高层模块，其直接依赖了实现细节 <code>ProgressBar</code>， </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Iprogress</span> &#123;     <span class="comment">// 观察者抽象接口</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DoProgress</span><span class="params">(<span class="type">float</span> value)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Iprogress</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileSplitter</span> &#123;    <span class="comment">// 主体</span></span><br><span class="line">  string m_filePath;</span><br><span class="line">  <span class="type">int</span> m_fileNumber;</span><br><span class="line">  vector&lt;Iprogress*&gt; m_iprogress;   <span class="comment">// 抽象的通知机制</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">FileSplitter</span>(<span class="type">const</span> string&amp; filePath , <span class="type">int</span> fileNumber , Iprogress* iprogress)  <span class="comment">// 新增进度条参数</span></span><br><span class="line">    : <span class="built_in">m_filePath</span>(filePath) , <span class="built_in">m_fileNumber</span>(fileNumber) , <span class="built_in">m_iprogress</span>(iprogress) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 读取大文件</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span> ; i&lt;m_fileNumber ; ++i) &#123;</span><br><span class="line">      <span class="type">float</span> progressValue = (<span class="type">float</span>)(i + <span class="number">1</span>) / m_fileNumber;</span><br><span class="line">      <span class="built_in">onProgress</span>(progressValue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">register</span><span class="params">(Iprogress* iprogress)</span> </span>&#123; m_iprogress.<span class="built_in">push_back</span>(iprogress);&#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">unregister</span><span class="params">(Iprogress* iprogress)</span> </span>&#123; m_iprogress.<span class="built_in">erase</span>(iprogress);&#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">onProgress</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    for_each(m_iprogress.<span class="built_in">begin</span>() , m_iprogress.<span class="built_in">end</span>() , </span><br><span class="line">          [&amp;context](<span class="keyword">auto</span>&amp;&amp; m_iprogress)&#123;m_iprogress-&gt;<span class="built_in">DoProgress</span>(context);&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainForm</span> : <span class="keyword">public</span> Form , <span class="keyword">public</span> Iprogress &#123;   <span class="comment">//观察者</span></span><br><span class="line">  TextBox* txtFilePath;     <span class="comment">// 所要分割的文件路径</span></span><br><span class="line">  TextBox* txtFileNumber;   <span class="comment">// 所要分割的文件数目</span></span><br><span class="line">  ProcessBar* processBar;   <span class="comment">// 新增进度条</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Button1_Click</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    string filePath = txtFilePath-&gt;<span class="built_in">getText</span>();</span><br><span class="line">    <span class="type">int</span> number = <span class="built_in">atoi</span>(txtFileNumber-&gt;<span class="built_in">getText</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="function">FileSplitter <span class="title">splitter</span><span class="params">(filePath , number , <span class="keyword">this</span>)</span></span>;</span><br><span class="line">    splitter.<span class="built_in">split</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="type">void</span> <span class="title">DoProgress</span><span class="params">(<span class="type">float</span> value)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    precessBar-&gt;<span class="built_in">setValue</span>(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>定义对象之间的一种一对多(变化)的依赖关系，以便当一个对象(subject)的状态发生改变时，所有依赖它的对象都得到通知并自动更新</p>
<p><img src="/img/Snipaste_2024-12-16_16-35-00.png"></p>
<ul>
<li>使用面向对象的抽象，Observer模式使得我们可以独立地改变目标与观察者，从而使两者之间的依赖关系达到松耦合</li>
<li>目标发送通知时，无需指定观察者，通知(可以携带通知信息作为参数)会自动传播</li>
<li>观察者自己决定是否需要订阅通知，目标对象一无所知</li>
</ul>
<h2 id="单一职责模式"><a href="#单一职责模式" class="headerlink" title="单一职责模式"></a>单一职责模式</h2><blockquote>
<p>在软件组件的设计中，如果责任划分的不清晰，使用继承得到的结果往往是随着需求的变化，子类急剧膨胀，同时充斥着重复代码，这时候的关键是划清责任</p>
<p>典型模式</p>
<ul>
<li><p>Decorator</p>
</li>
<li><p>Bridge</p>
</li>
</ul>
</blockquote>
<h3 id="装饰模式"><a href="#装饰模式" class="headerlink" title="装饰模式"></a>装饰模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在某些情况下我们可能会过度的使用继承来拓展对象的功能，由于继承为类型引入静态特质，使得这种拓展方式缺乏灵活性，并随着子类的增多(拓展功能的增多)，各种子类的组合(拓展功能的组合)会导致更多子类的膨胀。如何使对象功能的拓展能够根据需要来动态地实现？同时避免拓展功能的增多带来的子类膨胀问题？从而使得任何功能拓展变化导致的影响降到最低</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Stream</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="function"><span class="keyword">virtual</span> <span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>= <span class="number">0</span>;</span><br><span class="line"> <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>= <span class="number">0</span>;</span><br><span class="line"> <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>= <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">virtual</span> ~<span class="built_in">Stream</span>() &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileStream</span> : <span class="keyword">public</span> Stream &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123; &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123; &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NetStream</span> : <span class="keyword">public</span> Stream &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123; &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123; &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 拓展操作</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CryptoFileStream</span> : <span class="keyword">public</span> FileStream &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 加密操作</span></span><br><span class="line"> FileStream::<span class="built_in">Read</span>(number);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 加密操作</span></span><br><span class="line"> FileStream::<span class="built_in">Seek</span>(position);</span><br><span class="line"> <span class="comment">// 加密操作</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 加密操作</span></span><br><span class="line"> FileStream::<span class="built_in">Wirte</span>(data);</span><br><span class="line"> <span class="comment">// 加密操作</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CryptoNetStream</span> : <span class="keyword">public</span> NetStream &#123;&#125;; <span class="comment">// 网络流加密</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BufferFileStream</span> : <span class="keyword">public</span> FileStream &#123;&#125;; <span class="comment">// 文件流缓冲</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BufferNetStream</span> : <span class="keyword">public</span> NetStream &#123;&#125;; <span class="comment">// 网络流缓冲</span></span><br><span class="line"><span class="comment">// 文件流即加密又缓冲</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CryptoBufferFileStream</span> : <span class="keyword">public</span> FileStream &#123;&#125;<span class="comment">// 业务操作</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Stream</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="function"><span class="keyword">virtual</span> <span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>= <span class="number">0</span>;</span><br><span class="line"> <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>= <span class="number">0</span>;</span><br><span class="line"> <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>= <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">virtual</span> ~<span class="built_in">Stream</span>() &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileStream</span> : <span class="keyword">public</span> Stream &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123; &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123; &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NetStream</span> : <span class="keyword">public</span> Stream &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123; &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123; &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 拓展操作</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CryptoFileStream</span> : <span class="keyword">public</span> FileStream &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 加密操作</span></span><br><span class="line"> FileStream::<span class="built_in">Read</span>(number);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 加密操作</span></span><br><span class="line"> FileStream::<span class="built_in">Seek</span>(position);</span><br><span class="line"> <span class="comment">// 加密操作</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"> <span class="comment">// 加密操作</span></span><br><span class="line"> FileStream::<span class="built_in">Wirte</span>(data);</span><br><span class="line"> <span class="comment">// 加密操作</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CryptoNetStream</span> : <span class="keyword">public</span> NetStream &#123;&#125;; <span class="comment">// 网络流加密</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BufferFileStream</span> : <span class="keyword">public</span> FileStream &#123;&#125;; <span class="comment">// 文件流缓冲</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BufferNetStream</span> : <span class="keyword">public</span> NetStream &#123;&#125;; <span class="comment">// 网络流缓冲</span></span><br><span class="line"><span class="comment">// 文件流即加密又缓冲</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CryptoBufferFileStream</span> : <span class="keyword">public</span> FileStream &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Snipaste_2024-12-20_20-10-18.png"></p>
<p>此图是如上代码的继承关系，我们有太多的子类，而且存在过多的重复代码，如各个子类的加密操作，我们进行重构</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Stream</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Stream</span>() &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileStream</span> : <span class="keyword">public</span> Stream &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NetStream</span> : <span class="keyword">public</span> Stream &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecoratorStream</span> : <span class="keyword">public</span> Stream &#123; <span class="comment">// 装饰类</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    Stream* stream;</span><br><span class="line">    <span class="built_in">DecoratorStream</span>(Stream* stm) : <span class="built_in">stream</span>(stm) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CryptoStream</span> : <span class="keyword">public</span> Stream &#123; <span class="comment">//任然为流保持接口规范</span></span><br><span class="line">    Stream* stream; <span class="comment">// FileStream NetStream</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CryptoStream</span>(Stream* stm) : <span class="built_in">stream</span>(stm) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加密操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加密操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">// 加密操作</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加密操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Wirte</span>(data);</span><br><span class="line">        <span class="comment">// 加密操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BufferStream</span> : <span class="keyword">public</span> Stream &#123;  <span class="comment">// 文件流缓冲</span></span><br><span class="line">    Stream* stream;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">BufferStream</span>(Stream* stm) : <span class="built_in">stream</span>(stm) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 缓冲操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 缓冲操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 缓冲操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Wirte</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line"><span class="comment">// 文件流即加密又缓冲</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CryptoBufferStream</span> : <span class="keyword">public</span> Stream &#123;...&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FileStream* s1 = <span class="keyword">new</span> <span class="built_in">FileStream</span>();</span><br><span class="line">    CryptoStream* s2 = <span class="keyword">new</span> <span class="built_in">CryptoStream</span>(s1);    <span class="comment">//加密文件流</span></span><br><span class="line">    BufferStream* s3 = <span class="keyword">new</span> <span class="built_in">BufferStream</span>(s1);         <span class="comment">//加密缓冲流</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上已经满足需求了，当所有子类中拥有相同的成员时，我们可以将他提到基类中，显然提到Stream中是不合理的，所以我们也可以引入了装饰类</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Stream</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Stream</span>() &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileStream</span> : <span class="keyword">public</span> Stream &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NetStream</span> : <span class="keyword">public</span> Stream &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecoratorStream</span> : <span class="keyword">public</span> Stream &#123; <span class="comment">// 装饰类</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    Stream* stream;</span><br><span class="line">    <span class="built_in">DecoratorStream</span>(Stream* stm) : <span class="built_in">stream</span>(stm) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CryptoStream</span> : <span class="keyword">public</span> DecoratorStream&#123; <span class="comment">//任然为流保持接口规范</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CryptoStream</span>(Stream* stm) : <span class="built_in">DecoratorStream</span>(stm) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加密操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加密操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">// 加密操作</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加密操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Wirte</span>(data);</span><br><span class="line">        <span class="comment">// 加密操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BufferStream</span> : <span class="keyword">public</span> DecoratorStream&#123;  <span class="comment">// 文件流缓冲</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">BufferStream</span>(Stream* stm) : <span class="built_in">DecoratorStream</span>(stm) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">Read</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 缓冲操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Seek</span><span class="params">(<span class="type">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 缓冲操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Wirte</span><span class="params">(<span class="type">char</span> data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 缓冲操作</span></span><br><span class="line">        stream-&gt;<span class="built_in">Wirte</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line"><span class="comment">// 文件流即加密又缓冲</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CryptoBufferStream</span> : <span class="keyword">public</span> DecoratorStream&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FileStream* s1 = <span class="keyword">new</span> <span class="built_in">FileStream</span>();</span><br><span class="line">    CryptoStream* s2 = <span class="keyword">new</span> <span class="built_in">CryptoStream</span>(s1);    <span class="comment">//加密文件流</span></span><br><span class="line">    BufferStream* s3 = <span class="keyword">new</span> <span class="built_in">BufferStream</span>(s1);         <span class="comment">//加密缓冲流</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Snipaste_2024-12-24_13-14-42.png"></p>
<p>我们引入了<code>DecoratorStream</code>类，用于拓展操作，拓展的类依赖<code>Stream</code>的派生类</p>
<blockquote>
<p>define</p>
</blockquote>
<p>动态(组合)地给一个对象增加一些额外的指责。就增加功能而言，Decorator模式比生成子类(继承)更为灵活(消除重复代码 &amp; 减少子类个数)</p>
<p><img src="/img/Snipaste_2024-12-24_13-31-45.png"></p>
<ul>
<li><p>通过采用组合而非继承的首发，Decorator模式实现来运行时动态拓展对象功能的能力，而且可以根据需要拓展多个功能。避免来使用继承带来的灵活性差和多子类衍生问题</p>
</li>
<li><p>Decorator类在接口上表现为<strong>is-a Component</strong>继承关系，即<code>Decorator</code>类继承了<code>Component</code>类所拥有的接口。但实现上又变现为<strong>has-a Component</strong>的组合关系，即<code>Decorator</code>类又使用来另外一个<code>Component</code>类</p>
</li>
<li><p>Decorator模式的目的并非解决多子类衍生的多继承问题，Decorator模式应用的要点在于解决主体类在多个方向上的拓展功能 – “装饰”的含义</p>
</li>
</ul>
<h3 id="桥模式"><a href="#桥模式" class="headerlink" title="桥模式"></a>桥模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>由于某些类型的固有实现逻辑，使得它们具有两个变化的维度，乃至多个维度变化。如何应对这种”多维度的变化”? 如何利用面向对象技术来使得类型可以轻松地沿着两个乃至多个方向变化，而不引入额外的复杂度?</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Messageer</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Login</span><span class="params">(string username , string password)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">PlaySound</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DrawShape</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">WriteText</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Messageer</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//平台实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PCMessagerBase</span> : <span class="keyword">public</span> Messageer &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">PlaySound</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DrawShape</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">WriteText</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MobileMessagerBase</span> : <span class="keyword">public</span> Messageer &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">PlaySound</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DrawShape</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">WriteText</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//业务抽象</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PCMessagerLite</span> : <span class="keyword">public</span> PCMessagerBase &#123;  <span class="comment">// pc平台精简版</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Login</span><span class="params">(string username , string password)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        PCMessagerBase::<span class="built_in">Connect</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        PCMessagerBase::<span class="built_in">WriteText</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        PCMessagerBase::<span class="built_in">DrawShape</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PCMessagerPerfect</span> : <span class="keyword">public</span> PCMessagerBase &#123;   <span class="comment">// pc平台完美版</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Login</span><span class="params">(string username , string password)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        PCMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        PCMessagerBase::<span class="built_in">Connect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        PCMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        PCMessagerBase::<span class="built_in">WriteText</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        PCMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        PCMessagerBase::<span class="built_in">DrawShape</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MobileMessagerPerfect</span> : <span class="keyword">public</span> MobileMessagerBase &#123;  <span class="comment">// mobile平台精简版</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Login</span><span class="params">(string username , string password)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        MobileMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        MobileMessagerBase::<span class="built_in">Connect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        MobileMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        MobileMessagerBase::<span class="built_in">WriteText</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        MobileMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        MobileMessagerBase::<span class="built_in">DrawShape</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MobileMessagerLite</span> : <span class="keyword">public</span> PCMessagerBase &#123;  <span class="comment">// mobile平台精简版</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Login</span><span class="params">(string username , string password)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        MobileMessagerBase::<span class="built_in">Connect</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        MobileMessagerBase::<span class="built_in">WriteText</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        MobileMessagerBase::<span class="built_in">DrawShape</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>假设我们的业务抽象为m平台实现为n,那我们类的数目就有 m * n 个，我们发现PcMessagerLite和MobileMessagerLite中存在大量的重复代码对应的perfect中也同样存在。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Messager</span> &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    MessagerImpl* messageImpl; <span class="comment">//运行时确定是pcMessagerBase or mobileMessagerBase</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Messager</span>(MessagerImpl* impl) : <span class="built_in">messageImpl</span>(impl) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Login</span><span class="params">(string username , string password)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Messager</span>() = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessagerImpl</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">PlaySound</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DrawShape</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">WriteText</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">MessagerImpl</span>() = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//平台实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PCMessagerBase</span> : <span class="keyword">public</span> MessagerImpl &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">PlaySound</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DrawShape</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">WriteText</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MobileMessagerBase</span> : <span class="keyword">public</span> MessagerImpl &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">PlaySound</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">DrawShape</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">WriteText</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//业务抽象</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessagerLite</span> : Messager  &#123;  <span class="comment">// 精简版</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MessagerLite</span>(MessagerImpl* impl) : <span class="built_in">Messager</span>(impl) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Login</span><span class="params">(string username , string password)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        messageImpl-&gt;<span class="built_in">Connect</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        message-&gt;<span class="built_in">WriteText</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        messageImpl-&gt;<span class="built_in">DrawShape</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessagerPerfect</span> : Messager &#123;   <span class="comment">// 完美版</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MessagerPerfect</span>(MessagerImpl* impl) : <span class="built_in">Messager</span>(impl) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Login</span><span class="params">(string username , string password)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        message-&gt;<span class="built_in">PlaySound</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        message-&gt;<span class="built_in">Connect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        message-&gt;<span class="built_in">PlaySound</span>();</span><br><span class="line">        message-&gt;<span class="built_in">WriteText</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        message-&gt;<span class="built_in">PlaySound</span>();</span><br><span class="line">        message-&gt;<span class="built_in">DrawShape</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MessagerImpl* impl = <span class="keyword">new</span> PCMessagerBase;</span><br><span class="line">    Messager* message = <span class="keyword">new</span> <span class="built_in">MessagerLite</span>(impl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>将抽象部分(业务功能)与实现部分(平台实现)分离，使他们可以独立的变化</p>
<p><img src="/img/Snipaste_2024-12-27_15-42-55.png"></p>
<ul>
<li><p>Bridge 模式使用对象间的组合关系，解耦了抽象和实现之间固有的绑定关系，使得抽象和实现可以沿着各自的维度来变化。所谓抽象和实现沿着各个维度的变化即子类化他们</p>
</li>
<li><p>Bridge模式有时类似于多继承方案，但是多继承方案往往违背单一职责模式(一个类只有一个变化的原因)，复用型比较差。Bridge模式是比多继承方案更好的解决方法</p>
</li>
<li><p>Bridge模式的应用一般在两个非常强的变化维度，有时一个类也有多于两个的变化维度，这时可以使用Bridge的拓展模式</p>
</li>
</ul>
<h2 id="对象创建模式"><a href="#对象创建模式" class="headerlink" title="对象创建模式"></a>对象创建模式</h2><blockquote>
<p>通过对象创建模式绕开new,来避免对象创建(new)过程中所导致的紧耦合(依赖具体类)，从而支持对象创建的稳定。它是接口抽象之后的第一步工作</p>
<p>典型模式</p>
<ul>
<li><p>Factor Method</p>
</li>
<li><p>Abstract Factor</p>
</li>
<li><p>Prototype</p>
</li>
<li><p>Builder</p>
</li>
</ul>
</blockquote>
<h3 id="工厂方法"><a href="#工厂方法" class="headerlink" title="工厂方法"></a>工厂方法</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件系统中，经常面临着创建对象的工作，由于需求的变化，需要创建的对象的具体类型经常变化。如何应对这种变化？如何绕开常规的对象创建方法(new)，提供一种封装机制来避免客户程序和这种具体对象创建工作的紧耦合？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Form</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ISplitter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">split</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">ISplitter</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileSplitter</span> : ISplitter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BinarySplitter</span> : ISplitter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TxtSplitter</span> : ISplitter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VideoSplitter</span> : ISplitter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainForm</span> : <span class="keyword">public</span> Form &#123;</span><br><span class="line">    TextBox* txtFilePath;</span><br><span class="line">    TextBox* txtFileNumber;</span><br><span class="line">    ProgressBar* processBar;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Button1_Click</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        string filePath = txtFilePath-&gt;<span class="built_in">toString</span>();</span><br><span class="line">        <span class="type">int</span> number = <span class="built_in">atoi</span>(txtFileNumber-&gt;<span class="built_in">toString</span>());</span><br><span class="line">        ISplitter* splitter = <span class="keyword">new</span> <span class="built_in">FileSplitter</span>(filePath , number);  <span class="comment">// 依赖实现细节(具体类)</span></span><br><span class="line">        splitter-&gt;<span class="built_in">split</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上述代码中我们抽象了接口<code>ISplitter</code>,但是我们在MainForm中任然使用了实现细节<code>FileSplitter</code>，这违反了依赖倒置原则</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ISplitter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">split</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">ISplitter</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SplitterFactory</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 接口：工厂创建子类的方法，Factory Method 名字的由来</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ISplitter* <span class="title">CreateSplitter</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">SplitterFactory</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileSplitter</span> : <span class="keyword">public</span> ISplitter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BinarySplitter</span> : <span class="keyword">public</span> ISplitter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TxtSplitter</span> : <span class="keyword">public</span> ISplitter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileSplitterFactory</span> : SplitterFactory&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ISplitter* <span class="title">CreateSplitter</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FileSplitter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BinarySplitterFactory</span> : SplitterFactory&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ISplitter* <span class="title">CreateSplitter</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BinarySplitter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TxtSplitterFactory</span> : SplitterFactory&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ISplitter* <span class="title">CreateSplitter</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BinarySplitter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainForm</span> : <span class="keyword">public</span> Form &#123;</span><br><span class="line">    SplitterFactory* factory;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MainForm</span>(SplitterFactory* factory) &#123; <span class="comment">// 依赖注入</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;factory =factory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Button1_Click</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ISplitter* splitter = factory-&gt;<span class="built_in">CreateSplitter</span>();    <span class="comment">// 称为多肽new</span></span><br><span class="line">        splitter-&gt;<span class="built_in">split</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>经过修改后，MainForm只依赖抽象基类而不依赖具体实现，我们将变化的依赖赶到了MainForm的构造函数中</p>
<blockquote>
<p>define</p>
</blockquote>
<p>定义一个用于创建对象的接口，让子类决定实例化那一个类。<code>Factory Method</code> 使得一个类的实例化延迟(目的：解耦，手段：虚函数)到子类</p>
<p><img src="/img/Snipaste_2024-12-28_13-20-38.png"></p>
<ul>
<li><p>Factory Method 模式用于隔离类对象的使用者和具体类型之间的耦合关系。面对一个经常变化的具体类型，紧耦合关系(new)会导致软件的脆弱</p>
</li>
<li><p>Factory Method 模式通过面向对象的手法，将所要创建的具体对象工作延迟到子类，从而实现一种拓展(而非更改)的策略，叫好的解决了这种紧耦合关系</p>
</li>
<li><p>Factory Method模式解决单个对象的需求变化。缺点在于要求创建方法参数相同</p>
</li>
</ul>
<h3 id="抽象工厂"><a href="#抽象工厂" class="headerlink" title="抽象工厂"></a>抽象工厂</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件系统中，经常面临一系列相互依赖的对象的创建工作，同时，由于需求的变化，往往存在很多系列对象的创建工作。如何应对这种变化？如何绕过常规的对象创建方法(new)，提供一中封装机制来避免客户程序和这种多系列具体对象创建工作的紧耦合？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EmployeeDAO</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;EmployeeD0&gt; <span class="title">GetEmployees</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SqlConnection* connection = <span class="keyword">new</span> <span class="built_in">SqlConnection</span>();</span><br><span class="line">        connection-&gt;ConnectionSring = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">        SqlCommand* command = <span class="keyword">new</span> <span class="built_in">SqlCommand</span>();</span><br><span class="line">        command-&gt;CommandText = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">        SqlDataReader* reader = command-&gt;<span class="built_in">ExecuteReader</span>();</span><br><span class="line">        <span class="keyword">while</span>(reader-&gt;<span class="built_in">Read</span>()) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如上代码数据库已经和sqlServer绑定死了，不适用于多种数据库的变化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据库访问有关的基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBConnection</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBCommand</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBDataReader</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持SqlServer</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlConnection</span> : <span class="keyword">public</span> IDBConnection &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlCommand</span> : <span class="keyword">public</span> IDBCommand &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlDataReader</span> : <span class="keyword">public</span> IDataReader &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持Oracle</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OracleConnection</span> : <span class="keyword">public</span> IDBConnection &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OracleCommand</span> : <span class="keyword">public</span> IDBCommand &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OracleDataReader</span> : <span class="keyword">public</span> IDataReader &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EmployeeDAO</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;EmployeeD0&gt; <span class="title">GetEmployees</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IDBConnection* connection = <span class="keyword">new</span> <span class="built_in">SqlConnection</span>();</span><br><span class="line">        connection-&gt;ConnectionSring = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">        IDBCommand* command = <span class="keyword">new</span> <span class="built_in">SqlCommand</span>();</span><br><span class="line">        command-&gt;CommandText = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">        command-&gt;<span class="built_in">SetConnection</span>(connection);</span><br><span class="line">        IDBDataReader* reader = command-&gt;<span class="built_in">ExecuteReader</span>();</span><br><span class="line">        <span class="keyword">while</span>(reader-&gt;<span class="built_in">Read</span>()) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>为了支持多种数据库我们定义来接口，用多态的方式完成，由于需要new 子类所以任然不满足依赖倒置。我们很容易想到用工厂方法进行改良</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IDBConnection</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBCommand</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBDataReader</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBConnectionFactory</span> &#123; <span class="comment">/*virtual create method*/</span>&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBCommandFactory</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBDataReaderFactory</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持SqlServer</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlConnection</span> : <span class="keyword">public</span> IDBConnection &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlConnectionFactory</span> : IDBConnectionFactory &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlCommand</span> : <span class="keyword">public</span> IDBCommand &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlCommandFactory</span> : IDBCommandFactory &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlDataReader</span> : <span class="keyword">public</span> IDataReader &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们有三个接口，所以我们会有三个工厂接口<code>IDBConnectionFactory IDBCommandFactory IDBDataReaderFactory</code>，要实现<code>SqlConnectionFactory</code>用于创建<code>SqlConnection</code>，其他类如法炮制，在EmployeeDAO类中，要存放三个工厂接口的指针。由于Connection Command DataReader 之间存在关联性，必须操作同一类数据库。为了避免用户传参导致三者混乱我们有如下优化方法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IDBConnection</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBCommand</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBDataReader</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IDBFactory</span> &#123;  <span class="comment">// 将三个工厂合为一个工厂</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IDBConnection* <span class="title">CreateDBConnection</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IDBCommand* <span class="title">CreateDBCommand</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IDBDataReader* <span class="title">CreateDBDataReader</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持SqlServer</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlConnection</span> : <span class="keyword">public</span> IDBConnection &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlCommand</span> : <span class="keyword">public</span> IDBCommand &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlDataReader</span> : <span class="keyword">public</span> IDataReader &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqlFactory</span> : <span class="keyword">public</span> IDBFactory &#123;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> IDBConnection *<span class="title">CreateDBConnection</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> SqlConnection; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> IDBCommand *<span class="title">CreateDBCommand</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> SqlCommand; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> IDBDataReader *<span class="title">CreateDBDataReader</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> SqlDataReader; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持Oracle</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OracleConnection</span> : <span class="keyword">public</span> IDBConnection &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OracleCommand</span> : <span class="keyword">public</span> IDBCommand &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OracleDataReader</span> : <span class="keyword">public</span> IDataReader &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EmployeeDAO</span> &#123;</span><br><span class="line">    IDBFactory* DBfactory;  <span class="comment">// 构造函数，依赖注入</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;EmployeeD0&gt; <span class="title">GetEmployees</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IDBConnection* connection = DBfactory-&gt;<span class="built_in">CreateDBConnection</span>();</span><br><span class="line">        connection-&gt;ConnectionSring = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">        IDBCommand* command = DBfactory-&gt;<span class="built_in">CreateDBCommand</span>();</span><br><span class="line">        command-&gt;CommandText = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">        command-&gt;<span class="built_in">SetConnection</span>(connection);</span><br><span class="line">        IDBDataReader* reader = DBfactory-&gt;<span class="built_in">CreateDBDataReader</span>();</span><br><span class="line">        <span class="keyword">while</span>(reader-&gt;<span class="built_in">Read</span>()) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>由于connection command datareader之间存在关联性，我们把原来的三个工厂合为了一个工厂</p>
<blockquote>
<p>define</p>
</blockquote>
<p>提供一个接口(工厂)，让该接口负责创建一系列相关或者相互依赖的对象(多个工厂函数)，无需指定他们具体的类</p>
<p><img src="/img/Snipaste_2024-12-29_18-13-38.png"></p>
<ul>
<li><p>如果没有应对多系列对象构建的需求变化，则没有必要使用Abstract Factory模式，这时候简单工厂完全可以</p>
</li>
<li><p>系列对象指的是在某一特定系列下的对象之间有相互依赖或做用关系。不同系列的对象之间不能相互依赖</p>
</li>
<li><p>Abstract Factory模式主要在于应对新系列的需求变动。其缺点在难以应对新对象的需求变动</p>
</li>
</ul>
<h3 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件系统中，经常面临着某些<strong>结构复杂</strong>的对象的创建工作，由于需求的变化，这些对象经常面临剧烈的变化，但是他们却拥有比较稳定一致的接口。如何对应这种变化？如何向客户程序(使用这些对象的程序)隔离出这些易变对象，从而使得这些易变对象的客户程序不随着需求改变而变化？</p>
<p>我们对FactoryMethod的代码进行修改</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Form</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ISplitter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">split</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ISplitter* <span class="title">clone</span><span class="params">()</span> </span>= <span class="number">0</span>; <span class="comment">// 通过clone自己来创建对象</span></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">ISplitter</span>() = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileSplitter</span> : <span class="keyword">public</span> ISplitter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">ISplitter* <span class="title">clone</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">FileSplitter</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BinarySplitter</span> : <span class="keyword">public</span> ISplitter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">ISplitter* <span class="title">clone</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">BinarySplitter</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TxtSplitter</span> : <span class="keyword">public</span> ISplitter &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">ISplitter* <span class="title">clone</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">TxtSplitter</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainForm</span> : <span class="keyword">public</span> Form &#123;</span><br><span class="line">    ISplitter* prototype;   <span class="comment">// 用于clone,而不是直接使用</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MainForm</span>(ISplitter* prototype) &#123; <span class="comment">// 依赖注入</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;prototype=prototype;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Button1_Click</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ISplitter* splitter = prototype-&gt;<span class="built_in">clone</span>();    <span class="comment">// 称为多肽new</span></span><br><span class="line">        splitter-&gt;<span class="built_in">split</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>原型模式将抽象类和工厂基类进行了合并</p>
<blockquote>
<p>define</p>
</blockquote>
<p>使用原型实例指定创建对象的种类，然后通过拷贝这些原型来创建新的对象</p>
<p><img src="/img/Snipaste_2024-12-30_13-03-16.png"></p>
<ul>
<li><p>Prototype模式同样用于隔离对象的使用者和具体类型(易变)之间的耦合关系，它同样要求这些易变类拥有稳定的接口</p>
</li>
<li><p>Prototype模式对于如何创建易变类的实体对象采用原型克隆方法来做，它使得我们可以非常灵活的动态的创建拥有某些稳定接口的新对象(所需工作仅仅是注册一个新类的对象即原型然后在任何需要的地方使用clone)</p>
</li>
<li><p>Prototype模式中的clone方法可以利用某些框架中的序列化来实现深拷贝</p>
</li>
</ul>
<h2 id="对象性能模式"><a href="#对象性能模式" class="headerlink" title="对象性能模式"></a>对象性能模式</h2><blockquote>
<p>面向对象很好的解决了抽象的问题，但是必不可免的要付出一定的代价。对于通常情况来讲，面向对象的成本大都可以忽略不计。但是某些情况，面向对象所带来的成本必须谨慎处理</p>
<p>典型模式</p>
<ul>
<li><p>Singleton</p>
</li>
<li><p>Flywight</p>
</li>
</ul>
</blockquote>
<h3 id="单件模式"><a href="#单件模式" class="headerlink" title="单件模式"></a>单件模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件系统中，经常有这样一些特殊的类，必须保证它们在系统中只存在一个实例，才能确保它们的逻辑正确以及良好的效率。如何绕过常规的构造器，提供一种机制来保证一个类只有一个实例？这应该是类设计者的职责，而不是使用者的责任</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstddef&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">  <span class="built_in">Singleton</span>();</span><br><span class="line">  <span class="built_in">Singleton</span>(<span class="type">const</span> Singleton&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  Singleton&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Singleton&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">static</span> Singleton* <span class="title">getInstance</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="type">static</span> Singleton* m_instance;</span><br><span class="line">&#125;;</span><br><span class="line">Singleton* Singleton::m_instance = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="comment">//非线程安全</span></span><br><span class="line"><span class="function">Singleton* <span class="title">Singleton::getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    m_instance = <span class="keyword">new</span> <span class="built_in">Singleton</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> m_instance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//线程安全,但锁消耗过大，当对象已经创建</span></span><br><span class="line"><span class="comment">//再次调用getInstance属于读m_instance加锁无意义</span></span><br><span class="line"><span class="function">Singleton* <span class="title">Singleton::getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Lock lock;</span><br><span class="line">  <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    m_instance = <span class="keyword">new</span> <span class="built_in">Singleton</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> m_instance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//双检查锁,但由于内存读写reorder不安全</span></span><br><span class="line"><span class="function">Singleton* <span class="title">Singleton::getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;   <span class="comment">// 1</span></span><br><span class="line">    Lock lock;</span><br><span class="line">    <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      m_instance = <span class="keyword">new</span> <span class="built_in">Singleton</span>(); <span class="comment">// 2</span></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      1. 分配内存</span></span><br><span class="line"><span class="comment">      2. 调用构造器</span></span><br><span class="line"><span class="comment">      3. 将地址返回</span></span><br><span class="line"><span class="comment">      在reorder后指令顺序可能变为</span></span><br><span class="line"><span class="comment">      1. 分配内存</span></span><br><span class="line"><span class="comment">      2. 将地址返回</span></span><br><span class="line"><span class="comment">      3. 调用构造器</span></span><br><span class="line"><span class="comment">      在经历指令重排后，线程一执行了1 2 步骤直接将地址返回</span></span><br><span class="line"><span class="comment">      线程二进入getInstance函数，发现m_instance不为空直接返回</span></span><br><span class="line"><span class="comment">      m_instance,但是此时m_instance所指地址并没有调用构造器</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> m_instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//c++11版本之后的跨平台实现</span></span><br><span class="line">std::atomic&lt;Singleton*&gt; Singleton::m_instance;</span><br><span class="line">std::mutex Singleton::m_mutex;</span><br><span class="line"></span><br><span class="line"><span class="function">Singleton* <span class="title">Singleton::getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Singleton* tmp = m_instance.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">  std::<span class="built_in">atomic_thread_fence</span>(std::memory_order_acquire);</span><br><span class="line">  <span class="keyword">if</span>(tmp == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex)</span></span>;</span><br><span class="line">    tmp = m_instance.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">    <span class="keyword">if</span>(tmp == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      tmp = <span class="keyword">new</span> Singleton;</span><br><span class="line">      std::<span class="built_in">atomic_thread_fence</span>(std::memory_order_release);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>保证一个类仅有一个实例，并提供一个该实例的全局访问点</p>
<p><img src="/img/Snipaste_2025-01-05_13-17-19.png"></p>
<ul>
<li><p>Singleton 模式中的实例构造器可以设为为protected以允许子类派生</p>
</li>
<li><p>Singleton模式一般不要支持拷贝构造函数和Clone接口，因为这有可能导致多个对象实例，与Singleton模式的初衷违背</p>
</li>
</ul>
<h3 id="享元模式"><a href="#享元模式" class="headerlink" title="享元模式"></a>享元模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件系统中采用纯粹对象方案的问题在于大量细粒度的对象会很快充斥在系统中，从而带来很高的运行时代价(主要指内存需求方面的代价)。如何避免大量细粒度对象问题的同时，让外部客户程序任然能够透明的使用面向对象的方式来进行操作？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Font</span> &#123;</span><br><span class="line">  string key;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Font</span>(<span class="type">const</span> string&amp; key) &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FontFactory</span> &#123;</span><br><span class="line">  map&lt;string , Font*&gt; fontPool;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function">Font* <span class="title">GetFont</span><span class="params">(<span class="type">const</span> string&amp; key)</span> </span>&#123;</span><br><span class="line">    map&lt;string , Font*&gt;::iterator item = fontPool.<span class="built_in">find</span>(key);</span><br><span class="line">    <span class="keyword">if</span>(item != fontPool.<span class="built_in">end</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> footPool[key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      Font* font = <span class="keyword">new</span> <span class="built_in">Font</span>(key);</span><br><span class="line">      fontPool[key] = font;</span><br><span class="line">      <span class="keyword">return</span> font;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>运用共享技术有效的支持大量细粒度的对象</p>
<ul>
<li><p>面向对象很好的解决了抽象性问题，但是作为一个运行在机器中程序实体，我们需要考虑对象的代价问题。Flyweight主要解决面向对象的代价问题，一般不触及面向对象的抽象性问题</p>
</li>
<li><p>Flyweight采用对象共享的做法来降低系统中对象的个数，从而降低细粒度对象给系统带来的内存压力。在具体实现方面，要注意对象状态的处理</p>
</li>
<li><p>对象的数量太大从而导致对象埃格努内存开销加大，什么样的数量才算大？这需要我们仔细根据具体应用情况进行评估，而不能凭空臆断</p>
</li>
</ul>
<h2 id="接口隔离模式"><a href="#接口隔离模式" class="headerlink" title="接口隔离模式"></a>接口隔离模式</h2><blockquote>
<p>在组件构架过程中，某些接口之间直接的依赖常常会带来很多问题，甚至根本无法实现。采用添加一层间接(稳定)接口，来隔离本来互相紧密关联的接口是一种常见的解决方案</p>
<p>典型模式</p>
<ul>
<li><p>Facade</p>
</li>
<li><p>Proxy</p>
</li>
<li><p>Adapter</p>
</li>
<li><p>Mediator</p>
</li>
</ul>
</blockquote>
<h3 id="门面模式"><a href="#门面模式" class="headerlink" title="门面模式"></a>门面模式</h3><p><img src="/img/Snipaste_2025-01-08_10-59-52.png"></p>
<blockquote>
<p>Motivation</p>
</blockquote>
<p>上述A方案的问题在于组件的客户和组件中各种复杂的子系统有了过多的耦合，随着外部客户程序和各子系统的演化，这种过多的耦合面临很多变化的挑战。如何简化外部客户程序和系统间交互的接口？如何将外部客户程序的演化和内部子系统的变化之间的依赖相互解耦？</p>
<blockquote>
<p>define</p>
</blockquote>
<p>为子系统中的一组接口提供一致的界面，Facade模式定义了一个高层接口，这个接口使得这一子系统更加容易使用</p>
<ul>
<li><p>从客户程序的角度看，Facade模式简化来整个组件系统的接口，对于组件内部与外部客户程序来说，达到了一种解耦的效果，内部子系统的任何变化不用影响到Facade接口的变化</p>
</li>
<li><p>Facade设计模式更注重从架构的层次去看整个系统，而不是单个类的层次。Facade很多时候更是一种架构设计模式</p>
</li>
<li><p>Facade设计模式并非一个集装箱，可以任意的放进任何多个对象。Facade模式中组件的内部应该是相互耦合关系比较大的一系列组件，而不是一个简单的功能集合</p>
</li>
</ul>
<h3 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在面向对象系统中，有些对象由于某种原因(比如对象创建的开销大，或者某些操作需要安全控制，或者需要进程外的访问等)，直接访问会给使用者，或者系统结构带来很多麻烦。如何在不时去透明操作对象的同时来管理&#x2F;控制这些对象特有的复杂性？增加一层间接层是软件开发中常见的解决方式</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ISubject</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">process</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealSubject</span> : <span class="keyword">public</span> ISubject &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;<span class="comment">/*... */</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientApp</span> &#123;</span><br><span class="line">    ISubject* subject;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ClientApp</span>() &#123;</span><br><span class="line">        subject = <span class="keyword">new</span> RealSubject;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">DoTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        subject-&gt;<span class="built_in">process</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ISubject</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">process</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SubjectProxy</span> : <span class="keyword">public</span> ISubject &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对RealSubject的间接访问</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientApp</span> &#123;</span><br><span class="line">    ISubject* subject;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ClientApp</span>() &#123;</span><br><span class="line">        subject = <span class="keyword">new</span> SubjectProxy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">DoTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        subject-&gt;<span class="built_in">process</span>();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>为其他对象提供一种代理以控制(隔离，使用接口)对这个对象的访问。</p>
<p><img src="/img/Snipaste_2025-01-09_10-24-03.png"></p>
<ul>
<li><p>增加一层间接层是软件系统中对许多复杂问题的一种常见解决方法。在面向对象系统中，直接使用某些对象会带来很多问题，作为间接层的proxy对象便是这一问题的常用手段</p>
</li>
<li><p>具体proxy设计模式的实现方法，实现粒度都相差很大，有些可能对单个对象做细粒度的控制，如copy-on-write技术，有些可能对组件模块提供抽象代理层，在架构层次对对象做proxy</p>
</li>
<li><p>Proxy并不一定要求保持接口完整的一致性，只要能够实现间接控制，有时候损失一些透明性是可以接受的</p>
</li>
</ul>
<h3 id="适配器模式"><a href="#适配器模式" class="headerlink" title="适配器模式"></a>适配器模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件系统中，由于应用环境的变化，常常需要将一些现存的对象放在新的环境中应用，但是新环境要求的接口是这些现存对象所不满足的。如何应对这种迁移的变化？如何即能利用现有对象的良好实现，同时又能满足新的应用环境所要求的接口？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ITarget</span> &#123;     <span class="comment">// 目标接口(新接口)</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">process</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IAdaptee</span> &#123;    <span class="comment">// 遗留接口(老接口)</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> data)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">bar</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Adapter</span> : <span class="keyword">public</span> ITarget &#123;    <span class="comment">// 适配器</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    IAdaptee* pAdaptee;     <span class="comment">// 组合了老接口</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="type">int</span> data = pAdaptee-&gt;<span class="built_in">bar</span>();</span><br><span class="line">        pAdaptee-&gt;<span class="built_in">foo</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>将一个类的接口转换为客户希望的另一个接口。Adapter模式使得原本由于接口不兼容而不能一起工作的那些类可以一起工作</p>
<p><img src="/img/Snipaste_2025-01-10_11-15-05.png"></p>
<ul>
<li><p>Adapter模式主要应用于希望复用一些现纯的类，但是接口又与复用环境要求不一致的情况，在遗留代码复用 类库迁移等方面非常有用</p>
</li>
<li><p>GOF23定义了两种Adapter模式的实现结构，对象适配器和类适配器。但类适配器采用多继承的实现方法，一般不推荐使用。对象适配器采用对象组合的方式，更符合松耦合精神</p>
</li>
<li><p>Adapter模式可以实现的非常灵活，不必拘泥与GOF23中定义的两种结构。例如，完全可以将Adapter模式中现纯对象作为新的接口方法参数，来达到适配的目的</p>
</li>
</ul>
<h3 id="中介者模式"><a href="#中介者模式" class="headerlink" title="中介者模式"></a>中介者模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件构建过程中，经常会出现多个对象相互关联交互的情况，对象之间常常会维持一种复杂的引用关系，如果遇到一些需求的更改，这种直接的引用关系将面临不断的变化。这种情况下，我们可以使用一个中介对象来管理对象间的关联关系，避免相互交互对象之间的紧耦合引用关系，从而更好的抵御变化。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Colleague</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个中介者接口，包含对象改变所需调用函数。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mediator</span> &#123;</span><br><span class="line"><span class="keyword">public</span> :</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Mediator</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">changed</span><span class="params">(Colleague *)</span></span>=<span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义&quot;同事&quot;类接口，初始化需要一个中介者对象，并通过该类更新另外一个&quot;同事&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Colleague</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> :</span><br><span class="line">    <span class="comment">//初始化中介者类对象</span></span><br><span class="line">  <span class="built_in">Colleague</span>(Mediator *mediator) &#123; <span class="keyword">this</span>-&gt;mediator = mediator; &#125;</span><br><span class="line">  <span class="comment">// 更新另外一个类</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">changed</span><span class="params">()</span> </span>&#123; mediator-&gt;<span class="built_in">changed</span>(<span class="keyword">this</span>); &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Mediator *mediator;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//具体的同事类1</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConcreteColleague1</span> :<span class="keyword">public</span> Colleague</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">ConcreteColleague1</span>(Mediator *mediator) : <span class="built_in">Colleague</span>(mediator) &#123;&#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;update ConcreteColleague1 from ConcreteColleague2&quot;</span> &lt;&lt; endl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//具体的同事类2</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConcreteColleague2</span> :<span class="keyword">public</span> Colleague</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> :</span><br><span class="line">  <span class="built_in">ConcreteColleague2</span>(Mediator *mediator) : <span class="built_in">Colleague</span>(mediator) &#123;&#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;update ConcreteColleague2 from ConcreteColleague1&quot;</span> &lt;&lt; endl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//具体的中介者类，实现更新函数changed。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConcreteMediator</span> :<span class="keyword">public</span> Mediator &#123;</span><br><span class="line">    ConcreteColleague1 * colleague1;</span><br><span class="line">    ConcreteColleague2 * colleague2;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">setColleague1</span><span class="params">(ConcreteColleague1 *colleague)</span> </span>&#123; colleague1 = colleague; &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">setColleague2</span><span class="params">(ConcreteColleague2 *colleague)</span> </span>&#123; colleague2 = colleague; &#125;</span><br><span class="line">  <span class="built_in">ConcreteMediator</span>() &#123;</span><br><span class="line">    <span class="comment">// colleague1 = new ConcreteColleague1(this);</span></span><br><span class="line">  &#125;</span><br><span class="line">  ~<span class="built_in">ConcreteMediator</span>() &#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">changed</span><span class="params">(Colleague *colleague)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (colleague == colleague1) &#123;</span><br><span class="line">      colleague2-&gt;<span class="built_in">update</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colleague == colleague2) &#123;</span><br><span class="line">      colleague1-&gt;<span class="built_in">update</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">      ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ConcreteMediator concreteMediator;</span><br><span class="line">    <span class="function">ConcreteColleague1  <span class="title">colleague1</span><span class="params">(&amp;concreteMediator)</span></span>;</span><br><span class="line">    <span class="function">ConcreteColleague2  <span class="title">colleague2</span><span class="params">(&amp;concreteMediator)</span></span>;</span><br><span class="line">    concreteMediator.<span class="built_in">setColleague1</span>(&amp;colleague1);</span><br><span class="line">    concreteMediator.<span class="built_in">setColleague2</span>(&amp;colleague2);</span><br><span class="line">    <span class="comment">//&quot;同事1&quot;通过中介者更新&quot;同事2&quot;</span></span><br><span class="line">    colleague1.<span class="built_in">changed</span>();</span><br><span class="line">    <span class="comment">//&quot;同事2&quot;通过中介者更新&quot;同事1&quot;</span></span><br><span class="line">    colleague2.<span class="built_in">changed</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>用一个中介对象来封装(封装变化)一系列的对象交互。中介者使各对象不需要显式的相互引用(编译时依赖-&gt;运行时依赖)，从而使其耦合松散，而且可以独立的改变他们之间的交互</p>
<p><img src="/img/Snipaste_2025-01-11_12-59-19.png"></p>
<ul>
<li><p>将多个对象间复杂的关联关系解耦，Mediator模式将多个对象间的控制逻辑进行集中管理，变多个对象相互关联为多个对象和一个中介者关联，简化来系统的维护，抵御来可能的变化</p>
</li>
<li><p>随着控制逻辑的复杂化，Mediator具体对象的实现可能相当复杂。这时候可以对Mediator对象进行分解处理</p>
</li>
<li><p>Facade模式是解耦系统间(单向)的对象关联关系，Mediator模式是解耦系统内各个对象之间(双向)的关联关系</p>
</li>
</ul>
<p>、</p>
<h2 id="状态变化模式"><a href="#状态变化模式" class="headerlink" title="状态变化模式"></a>状态变化模式</h2><blockquote>
<p>在组件构建过程中，某些对象的状态经常面临变化，如何对这种变化进行有效的管理？同时又维持高层模块的稳定？状态变化模式为这一问题提供了一种解决方案。</p>
<p>典型模式：</p>
<ul>
<li><p>State</p>
</li>
<li><p>Memento</p>
</li>
</ul>
</blockquote>
<h3 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件构建过程中，某些对象的状态如果改变，其行为也会随之发生变化，比如文档处于只读状态，其支持的行为和读写状态支持的行为就可能完全不同。如何在运行时根据对象的状态来透明的更改对象的行为？而不会为对象操作和状态转换之间引入紧耦合。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">NetWorkState</span> &#123;</span><br><span class="line">  Network_Open,</span><br><span class="line">  Network_Close,</span><br><span class="line">  Network_Connect,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkProcessor</span> &#123;</span><br><span class="line">  NetWorkState state;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Operator1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(state == NetWorkState::Network_Open) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      state = NetWorkState::Network_Close;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(state == NetWorkState::Network_Close) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      state = NetWorkState::Network_Connect;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(state == NetWorkState::Network_Connect) &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      state = NetWorkState::Network_Open;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Operator2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(state == NetWorkState::Network_Open) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      state = NetWorkState::Network_Connect;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(state == NetWorkState::Network_Close) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      state = NetWorkState::Network_Open;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(state == NetWorkState::Network_Connect) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">       state = NetWorkState::Network_Close;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当状态增加或发生变化时，我们要修改每一个operator</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkState</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  NetworkState* pNext;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Operator1</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Operator2</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">NetworkState</span>() = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpenState</span> : <span class="keyword">public</span> NetworkState &#123;</span><br><span class="line">  <span class="type">static</span> NetworkState* m_instance;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">static</span> NetworkState* <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      m_instance = <span class="keyword">new</span> OpenState&#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_instance;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Operator1</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    pNext = CloseState::<span class="built_in">getInstance</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Operator2</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    pNext = ConnectState::<span class="built_in">getInstance</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CloseState</span> : <span class="keyword">public</span> NetworkState &#123;</span><br><span class="line">  <span class="type">static</span> NetworkState* m_instance;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">static</span> NetworkState* <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      m_instance = <span class="keyword">new</span> CloseState&#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_instance;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Operator1</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    pNext = CloseState::<span class="built_in">getInstance</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Operator2</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    pNext = OpenState::<span class="built_in">getInstance</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConnectState</span>: <span class="keyword">public</span> NetworkState &#123;</span><br><span class="line">  <span class="type">static</span> NetworkState* m_instance;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">static</span> NetworkState* <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      m_instance = <span class="keyword">new</span> ConnectState&#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_instance;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Operator1</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Operator2</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkProcessor</span> &#123;</span><br><span class="line">  NetworkState* pState;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">NetworkProcessor</span>(NetworkState* pState) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;pState = pState;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Operator1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    pState-&gt;<span class="built_in">Operator1</span>();</span><br><span class="line">    pState = pState-&gt;pNext;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Operator2</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    pState-&gt;<span class="built_in">Operator2</span>();</span><br><span class="line">    pState = pState-&gt;pNext;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当增加wait状态时，我们只需要写新的waitState即可。</p>
<blockquote>
<p>define</p>
</blockquote>
<p>允许一个对象在其内部状态改变时改变它的行为。从而使对象看起来似乎修改了其行为</p>
<p><img src="/img/Snipaste_2025-01-12_12-22-33.png"></p>
<ul>
<li><p>State模式将所有与一个特定状态相关的行为都放入一个State的子类对象中，在对象切换时，切换相应的对象，但同时维持State的接口，这样实现来具体操作与状态转换之间的解耦</p>
</li>
<li><p>为不同状态引入不同的对象使得状态转换变的更加明确，而且可以保证不会出现状态不一致的情况，因为转换是原子性的，即要么彻底转换过来，要么不转换</p>
</li>
<li><p>如何State对象没有实例变量，那么各个上下文可以共享一个State对象，从而节省对象开销</p>
</li>
</ul>
<h3 id="备忘录模式"><a href="#备忘录模式" class="headerlink" title="备忘录模式"></a>备忘录模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件构建过程中，某些对象的状态在转换过程中，可能由于某种需求，要求程序能够回溯到对象之前处于某个点时的状态。如果使用一些公有接口来让其他对象得到对象的状态，便会暴露对象的细节实现。如何实现对象状态的良好保存与恢复？但同时又不会因此而破坏对象本身的封装性。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Memento</span> &#123;</span><br><span class="line">  std::string state;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Memento</span>(<span class="type">const</span> std::string&amp; s) : <span class="built_in">state</span>(s) &#123; &#125;</span><br><span class="line">  <span class="function">std::string <span class="title">getState</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> state; &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">setState</span><span class="params">(<span class="type">const</span> std::string&amp; s)</span> </span>&#123; state = s; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Originator</span> &#123;</span><br><span class="line">  std::string state;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Originator</span>() = <span class="keyword">default</span>;</span><br><span class="line">  <span class="function">Memento <span class="title">createMomento</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">Memento <span class="title">m</span><span class="params">(state)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">setMomento</span><span class="params">(<span class="type">const</span> Memento&amp; m)</span> </span>&#123; state = m.<span class="built_in">getState</span>(); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Originator originator;</span><br><span class="line">  Memento mem = originator.<span class="built_in">createMomento</span>(); <span class="comment">// 存储到备忘录</span></span><br><span class="line">  <span class="comment">// ... originator 状态发生改变</span></span><br><span class="line">  originator.<span class="built_in">setMomento</span>(mem); <span class="comment">// 从备忘录中恢复</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>在不破坏封装性的前提下，捕获一个对象内部状态，并在该对象之外保存这个状态。这样以后就可以将该对象恢复到原先保存的状态。</p>
<p><img src="/img/Snipaste_2025-01-15_12-03-40.png"></p>
<ul>
<li><p>备忘录存储原发器(Originator)对象内部状态，在需要时恢复原发器状态</p>
</li>
<li><p>Memento模式的核心是信息隐藏，即Originatro需要向外界隐藏信息，保持其封装性。但同时又需要将状态保持到外界(Memento)</p>
</li>
<li><p>由于现代语言运行时都具有相当的对象序列化支持，因此往往采用效率高又容易正确实现的序列化方案来实现Memento模式</p>
</li>
</ul>
<h2 id="数据结构模式"><a href="#数据结构模式" class="headerlink" title="数据结构模式"></a>数据结构模式</h2><blockquote>
<p>常常有一些组件在内部具有特定的数据结构，如果让客户程序依赖这些特定的数据结构，将极大的破坏组件的复用。这时候，将这些特定数据结构封装在内部，在外部提供统一的接口，来实现与特定数据结构无关的访问，是一种行之有效的解决方案</p>
<p>典型模式：</p>
<ul>
<li><p>Composite</p>
</li>
<li><p>Iterator</p>
</li>
<li><p>Chain of Resposibility</p>
</li>
</ul>
</blockquote>
<h3 id="组件模式"><a href="#组件模式" class="headerlink" title="组件模式"></a>组件模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件在某些情况下，客户代码过多的依赖与对象容器复杂的内部实现结构，对象容器内部实现结构(而非抽象接口)的变化将引起客户代码的频繁变化，带来了代码的维护性，拓展型等弊端。如何将客户代码与复杂的对象容器结构解耦？让对象容器自己来实现自身的复杂结构，从而使得客户代码就像处理简单对象一样来处理复杂的对象容器？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 树节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Component</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">process</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Component</span>() = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Composite</span> : <span class="keyword">public</span> Component &#123;</span><br><span class="line">  std::string name;</span><br><span class="line">  std::list&lt;Component*&gt; elements;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Composite</span>(<span class="type">const</span> std::string&amp; s) : <span class="built_in">name</span>(s) &#123; &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(Component* element)</span> </span>&#123;</span><br><span class="line">    elements.<span class="built_in">push_back</span>(element);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(Component* element)</span> </span>&#123;</span><br><span class="line">    elements.<span class="built_in">remove</span>(element);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. process cur nodes</span></span><br><span class="line">    <span class="comment">// 2. process leaf nodes</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; e : elements) &#123;</span><br><span class="line">      e-&gt;<span class="built_in">process</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 叶子节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Leaf</span> : <span class="keyword">public</span> Component &#123;</span><br><span class="line">  std::string name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Leaf</span>(std::string s) : <span class="built_in">name</span>(s) &#123; &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// process current node</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">Composite <span class="title">root</span><span class="params">(<span class="string">&quot;root&quot;</span>)</span></span>;</span><br><span class="line">  <span class="function">Composite <span class="title">treeNode1</span><span class="params">(<span class="string">&quot;treeNode1&quot;</span>)</span></span>;</span><br><span class="line">  <span class="function">Composite <span class="title">treeNode2</span><span class="params">(<span class="string">&quot;treeNode2&quot;</span>)</span></span>;</span><br><span class="line">  <span class="function">Composite <span class="title">treeNode3</span><span class="params">(<span class="string">&quot;treeNode3&quot;</span>)</span></span>;</span><br><span class="line">  <span class="function">Composite <span class="title">treeNode4</span><span class="params">(<span class="string">&quot;treeNode4&quot;</span>)</span></span>;</span><br><span class="line">  <span class="function">Leaf <span class="title">left1</span><span class="params">(<span class="string">&quot;left1&quot;</span>)</span></span>;</span><br><span class="line">  <span class="function">Leaf <span class="title">left2</span><span class="params">(<span class="string">&quot;left2&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  root.<span class="built_in">add</span>(&amp;treeNode1);</span><br><span class="line">  treeNode1.<span class="built_in">add</span>(&amp;treeNode2);</span><br><span class="line">  treeNode2.<span class="built_in">add</span>(&amp;left1);</span><br><span class="line">  root.<span class="built_in">add</span>(&amp;treeNode3);</span><br><span class="line">  treeNode3.<span class="built_in">add</span>(&amp;treeNode4);</span><br><span class="line">  treeNode4.<span class="built_in">add</span>(&amp;left2);</span><br><span class="line"></span><br><span class="line">  root.<span class="built_in">process</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>将对象组合成树形结构以表示”部分 - 整体”的层次结构。Composite使得用户对单个对象和组合对象的使用具有一致性(稳定)</p>
<p><img src="/img/Snipaste_2025-01-16_12-10-29.png"></p>
<ul>
<li><p>Composite 模式采用树形结构来实现普遍存在的对象容器，从而将一对多的关系转化为一对一的关系，使得客户代码可以一致的处理对象和对象容器，无需关系处理的是单个对象，还是组合对象容器</p>
</li>
<li><p>将客户代码与复杂的对象容器结构解耦是Composite的核心思想，解耦后，客户代码将与纯粹的抽象解决(而非对象容器的内部实现结构)发生依赖，从而更能应对变化</p>
</li>
<li><p>Composite模式在具体实现中，可以让父对象中的子对象反向追溯，如果父对象有频繁的便利需求，可使用缓存技巧来改善效率</p>
</li>
</ul>
<h3 id="职责链"><a href="#职责链" class="headerlink" title="职责链"></a>职责链</h3><blockquote>
<p>在软件构建过程中，一个请求可能被多个对象处理，但是每个请求在运行时智能有一个接受者，如果显示指定，将必不可少的带来请求者与接受者的紧耦合。如何使请求的发送者不需要指定具体的接受者？让请求的接受者自己在运行时决定来处理请求，从而使两者解耦。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">RequeseType</span> &#123;</span><br><span class="line">    REQ_HENDLER1,</span><br><span class="line">    REQ_HENDLER2,</span><br><span class="line">    REQ_HENDLER3</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Request</span> &#123;</span><br><span class="line">    std::string description;</span><br><span class="line">    RequeseType reqType;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Request</span>(<span class="type">const</span> std::string&amp; desc , RequeseType type) </span><br><span class="line">        : <span class="built_in">description</span>(desc) , <span class="built_in">reqType</span>(type) &#123; &#125;</span><br><span class="line">    <span class="function">RequeseType <span class="title">getReqType</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> reqType; &#125;</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">getDescription</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> description; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChainHandler</span> &#123;</span><br><span class="line">    ChainHandler* nextChain;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendReqestToNextHandler</span><span class="params">(<span class="type">const</span> Request&amp; req)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(nextChain != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            nextChain-&gt;<span class="built_in">handle</span>(req);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">canHandleRequest</span><span class="params">(<span class="type">const</span> Request&amp; req)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">processRequest</span><span class="params">(<span class="type">const</span> Request&amp; req)</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ChainHandler</span>() &#123; nextChain = <span class="literal">nullptr</span>; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setNextChain</span><span class="params">(ChainHandler* next)</span> </span>&#123; nextChain = next; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handle</span><span class="params">(<span class="type">const</span> Request&amp; req)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">canHandleRequest</span>(req)) &#123;</span><br><span class="line">            <span class="built_in">processRequest</span>(req);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">sendReqestToNextHandler</span>(req);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Headler1</span> : <span class="keyword">public</span> ChainHandler &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">canHandleRequest</span><span class="params">(<span class="type">const</span> Request&amp; req)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> req.<span class="built_in">getReqType</span>() == RequeseType::REQ_HENDLER1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">processRequest</span><span class="params">(<span class="type">const</span> Request&amp; req)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Headler1 is handle reqest&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Headler2</span> : <span class="keyword">public</span> ChainHandler &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">canHandleRequest</span><span class="params">(<span class="type">const</span> Request&amp; req)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> req.<span class="built_in">getReqType</span>() == RequeseType::REQ_HENDLER2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">processRequest</span><span class="params">(<span class="type">const</span> Request&amp; req)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Headler2 is handle reqest&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Headler3</span> : <span class="keyword">public</span> ChainHandler &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">canHandleRequest</span><span class="params">(<span class="type">const</span> Request&amp; req)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> req.<span class="built_in">getReqType</span>() == RequeseType::REQ_HENDLER3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">processRequest</span><span class="params">(<span class="type">const</span> Request&amp; req)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Headler3 is handle reqest&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Headler1 h1;</span><br><span class="line">    Headler2 h2;</span><br><span class="line">    Headler3 h3;</span><br><span class="line">    h1.<span class="built_in">setNextChain</span>(&amp;h2);</span><br><span class="line">    h2.<span class="built_in">setNextChain</span>(&amp;h3);</span><br><span class="line">    <span class="function">Request <span class="title">req</span><span class="params">(<span class="string">&quot;process task&quot;</span>, RequeseType::REQ_HENDLER3)</span></span>;</span><br><span class="line">    h1.<span class="built_in">handle</span>(req);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>使多个对象都有机会处理请求，从而避免请求的发送者和接收者之间的耦合关系。将这些对象连成一条链，并沿着这条链请求，直到有一个对象处理它为止。</p>
<p><img src="/img/Snipaste_2025-01-17_14-18-44.png"></p>
<ul>
<li><p>Chain of Responsibility 模式的应用场合在于一个请求可能有多个接受者，但是最后真正的接受者只有一个，这时候请求发送者与接受者的耦合有可能出现变化脆弱的症状，责任链的目的就是将二者解耦，从而更好的应对变化</p>
</li>
<li><p>应用来 Chain or Responsibility 模式后，对象的职责分派将更具灵活性。我们可以在运行时动态添加或修改的处理职责</p>
</li>
<li><p>如果请求传递到职责链的末尾仍得不到处理，应该有一个合理的缺省机制。这也是每一个接受对象的责任，而不是发出请求对象的责任</p>
</li>
</ul>
<h2 id="行为变化模式"><a href="#行为变化模式" class="headerlink" title="行为变化模式"></a>行为变化模式</h2><blockquote>
<p>在组件的构建过程中，组件行为的变化经常导致组件本身剧烈的变化。行为变化模式将组件的行为和组件本身进行解耦，从而支持行为的变化，实现两者之间的松耦合</p>
<p>典型模式：</p>
<ul>
<li><p>Command</p>
</li>
<li><p>Visitor</p>
</li>
</ul>
</blockquote>
<h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件构建过程中，行为请求者与行为实现者通常呈现一种紧耦合。但在某些场合，比如需要对行为进行记录 撤销 等处理，这种无法抵御变化的紧耦合是不合适的。这种情况下，如何将行为请求者与行为实现者解耦？这一组行为抽象为对象，可以实现二者的松耦合</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Command</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">execute</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConcreteCommand1</span> : <span class="keyword">public</span> Command &#123;</span><br><span class="line">    std::string arg;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ConcreteCommand1</span>(<span class="type">const</span> std::string&amp; a) : <span class="built_in">arg</span>(a) &#123; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">execute</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;#1 process...&quot;</span> &lt;&lt; arg &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConcreteCommand2</span> : <span class="keyword">public</span> Command &#123;</span><br><span class="line">    std::string arg;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ConcreteCommand2</span>(<span class="type">const</span> std::string&amp; a) : <span class="built_in">arg</span>(a) &#123; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">execute</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;#2 process...&quot;</span> &lt;&lt; arg &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MacroCommand</span> : <span class="keyword">public</span> Command &#123;</span><br><span class="line">    std::vector&lt;Command*&gt; commands;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addCommand</span><span class="params">(Command* c)</span> </span>&#123;</span><br><span class="line">        commands.<span class="built_in">push_back</span>(c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">execute</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> <span class="type">const</span>&amp; c : commands) &#123;</span><br><span class="line">            c-&gt;<span class="built_in">execute</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>将一个请求(行为)封装为一个对象，从而可用不同的请求对客户进行参数化，对请求排队或记录请求日志，以及支持可撤销操作</p>
<ul>
<li><p>Command 模式的根本目的在于将行为请求者与行为实现者解耦，在面向对象语言中，常见的手段是将行为抽象为对象</p>
</li>
<li><p>实现Command接口的具体命令ConcreteCommand有时候更具需要可能会保存一些额外的状态信息。通过使用Composite模式，可以将多个命令封装为一个复合命令 MacroCommadn</p>
</li>
<li><p>Command模式与c++中函数对象有些类似。但二者定义行为接口的规范有所区别。Command以面向对象中接口-实现来定义行为接口规范，更严格，但有失性能，c++函数对象以函数签名来定义行为接口规范，更灵活，性能更高</p>
</li>
</ul>
<h3 id="访问器"><a href="#访问器" class="headerlink" title="访问器"></a>访问器</h3><blockquote>
<p>Motivation</p>
</blockquote>
<p>在软件构建过程中，由于需求的改变，某些层次结构中常常需要增加新的行为，如果直接在基类中做这样的更改，将会给子类带来很繁重的变更负担，甚至破坏原有的设计。如何在不更改类层次结构的前提下，在<strong>运行时</strong>根据需要透明的为类层次结构上各个类动态的添加新的操作，从而避免上述问题</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ElementA</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ElementB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Visitor</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">visitElementA</span><span class="params">(ElementA&amp; element)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">visitElementB</span><span class="params">(ElementB&amp; element)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Visitor</span>() = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Element</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//预知未来会添加新操作,但不知道添加的具体方法</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">accept</span><span class="params">(Visitor&amp; visitor)</span> </span>= <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Element</span>() &#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ElementA</span> : <span class="keyword">public</span> Element &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">accept</span><span class="params">(Visitor&amp; visitor)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        visitor.<span class="built_in">visitElementA</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ElementB</span> : <span class="keyword">public</span> Element &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">accept</span><span class="params">(Visitor&amp; visitor)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        visitor.<span class="built_in">visitElementB</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==============</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Visitor1</span> : <span class="keyword">public</span> Visitor &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">visitElementA</span><span class="params">(ElementA&amp; element)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Visitor1 is processing ElementA&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">visitElementB</span><span class="params">(ElementB&amp; element)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Visitor1 is processing ElementB&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Visitor2</span> : <span class="keyword">public</span> Visitor &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">visitElementA</span><span class="params">(ElementA&amp; element)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Visitor2 is processing ElementA&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">visitElementB</span><span class="params">(ElementB&amp; element)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Visitor2 is processing ElementB&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Visitor2 visitor;</span><br><span class="line">    ElementB element;</span><br><span class="line">    element.<span class="built_in">accept</span>(visitor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>define</p>
</blockquote>
<p>表示一个作用于某对象结构中各个元素的操作。使得可以在不改变(稳定)各元素类的前提下定义(拓展)作用于这些元素的新操作(变化)</p>
<p><img src="/img/Snipaste_2025-01-23_11-04-19.png"></p>
<ul>
<li><p>Visitor模式通过所谓的双重分发来实现在不更改Element类层次结构的前提下，在运行时透明的为类层次结构上的各个类动态添加新的操作</p>
</li>
<li><p>所谓的双重分发即Visitor模式中间包括两个多态分发，第一个accept方法的多态辨析，第二个为visitElementX方法的多态辨析</p>
</li>
<li><p>Visitor模式的最大缺点在于拓展类层次结构(添加新的Element子类)，会导致Visitor类的改变。<strong>因此Visitor模式适用于Element类层次结构稳定，而其中的操作却经常面临频繁改动</strong></p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/269835115">https://zhuanlan.zhihu.com/p/269835115</a> </p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7079753503920357407">C++ 设计模式 - 代理模式在某些情况下，客户端代码不适合或者不能直接引用另一个对象，而代理对象可以在客户端和目标对象 - 掘金</a>， </p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">tags</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/boolsatellite">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">设计模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%8D%8F%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">组件协作模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">模板方法：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.2.</span> <span class="toc-text">策略模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.3.</span> <span class="toc-text">观察者模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">单一职责模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.1.</span> <span class="toc-text">装饰模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%A5%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">桥模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">对象创建模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.1.</span> <span class="toc-text">工厂方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82"><span class="toc-number">1.3.2.</span> <span class="toc-text">抽象工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">原型模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E6%80%A7%E8%83%BD%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">对象性能模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%BB%B6%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.1.</span> <span class="toc-text">单件模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.2.</span> <span class="toc-text">享元模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.</span> <span class="toc-text">接口隔离模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%A8%E9%9D%A2%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.1.</span> <span class="toc-text">门面模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.2.</span> <span class="toc-text">代理模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.3.</span> <span class="toc-text">适配器模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E4%BB%8B%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.4.</span> <span class="toc-text">中介者模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.6.</span> <span class="toc-text">状态变化模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.6.1.</span> <span class="toc-text">状态模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.6.2.</span> <span class="toc-text">备忘录模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.</span> <span class="toc-text">数据结构模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.1.</span> <span class="toc-text">组件模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%8C%E8%B4%A3%E9%93%BE"><span class="toc-number">1.7.2.</span> <span class="toc-text">职责链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%8C%E4%B8%BA%E5%8F%98%E5%8C%96%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.8.</span> <span class="toc-text">行为变化模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.8.1.</span> <span class="toc-text">命令模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%99%A8"><span class="toc-number">1.8.2.</span> <span class="toc-text">访问器</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&text=设计模式"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&title=设计模式"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&is_video=false&description=设计模式"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=设计模式&body=Check out this article: http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&title=设计模式"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&title=设计模式"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&title=设计模式"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&title=设计模式"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&name=设计模式&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/02/06/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/&t=设计模式"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    boolsatellite
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/boolsatellite">Projects</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SPWV8NBZ00"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-SPWV8NBZ00');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
